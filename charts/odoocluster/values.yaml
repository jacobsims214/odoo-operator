# =============================================================================
# AWS EKS Production Values for OdooCluster
# =============================================================================
#
# Prerequisites:
#   - AWS Load Balancer Controller installed in cluster
#   - ACM certificate provisioned and validated
#   - EBS CSI driver for gp3 storage class
#   - (Optional) EFS CSI driver for RWX storage (recommended for multi-replica Odoo)
#
# Deploy with:
#   helm install my-company ./charts/odoocluster \
#     -n odoo-my-company --create-namespace \
#     -f values-aws.yaml \
#     --set networking.ingress.odoo.host=odoo.example.com \
#     --set networking.ingress.bi.host=bi.example.com \
#     --set networking.ingress.annotations."alb\.ingress\.kubernetes\.io/certificate-arn"=arn:aws:acm:us-east-1:123456789:certificate/xxxxx
#
# =============================================================================

# Cluster name (set this or use --set name=xxx)
name: ""

# =============================================================================
# Odoo Configuration
# =============================================================================
odoo:
  # Odoo 19 for latest features
  version: "19"
  
  # 3 replicas for high availability
  replicas: 3
  
  # Storage for Odoo filestore
  # NOTE: Multi-replica Odoo requires RWX storage (EFS on AWS)
  storage: "50Gi"
  # Storage class for filestore - MUST support ReadWriteMany for multi-replica
  storageClassName: "efs-sc"
  
  # Production resource allocation
  resources:
    requests:
      cpu: "1"
      memory: "4Gi"
    limits:
      cpu: "4"
      memory: "16Gi"
  
  # Addon modules - cloned before restore/init
  addons:
    # Odoo Enterprise (private fork)
    # Requires deploy key: kubectl create secret generic odoo-enterprise-deploy-key \
    #   --from-file=ssh-privatekey=./enterprise-deploy-key -n <namespace>
    - name: "enterprise"
      repo: "git@github.com:Lifestyle-Aviation-Systems/enterprise.git"
      branch: "19.0"
      deployKeySecret: "odoo-enterprise-deploy-key"
    
    # OCA Web Responsive - Better mobile UI
    - name: "oca-web"
      repo: "https://github.com/OCA/web.git"
      branch: "19.0"
      path: "web_responsive"
      install: false  # Set true for fresh install, false when restoring
    
    # OCA Session DB - Stores sessions in PostgreSQL for multi-replica support
    # REQUIRED for multi-replica Odoo - install after restore via Apps menu
    # https://github.com/OCA/server-tools/tree/19.0/session_db
    - name: "oca-server-tools"
      repo: "https://github.com/OCA/server-tools.git"
      branch: "19.0"
      path: "session_db"
      install: false  # Install manually after restore (new module)

# =============================================================================
# Database Configuration (CloudNative-PG)
# =============================================================================
database:
  # Storage size - uses gp3 by default on EKS
  storage: "100Gi"
  
  # Storage class name - required on EKS Auto Mode, optional otherwise
  # For EBS volumes (recommended for database): "ebs-sc" (RWO)
  storageClassName: "ebs-sc"
  
  # 3 PostgreSQL instances for HA (1 primary + 2 replicas)
  instances: 3
  
  # Production database resources
  resources:
    requests:
      cpu: "500m"
      memory: "2Gi"
    limits:
      cpu: "2"
      memory: "8Gi"
  
  # S3 backup configuration
  backup:
    enabled: true
    schedule: "0 2 * * *"  # 2 AM daily
    retentionPolicy: "30d"
    s3:
      # S3 endpoint for your region (leave empty for default AWS S3)
      endpoint: ""
      # S3 bucket name for backups
      bucket: ""  # Set via --set database.backup.s3.bucket=your-backup-bucket
      # Secret containing ACCESS_KEY_ID and SECRET_ACCESS_KEY
      # Create with: kubectl create secret generic backup-s3-creds \
      #   --from-literal=ACCESS_KEY_ID=xxx --from-literal=SECRET_ACCESS_KEY=xxx
      secretName: "backup-s3-creds"

  # Restore from existing backup (runs ONCE, then skips normal db init)
  # Use this when migrating from Odoo.sh or another Odoo instance
  # After successful restore, set enabled: false and redeploy
  restore:
    enabled: true  # Enable for initial migration from Odoo.sh
    s3:
      # S3 endpoint URL - leave empty for default AWS S3
      endpoint: "https://s3.amazonaws.com"
      # S3 bucket - same bucket used for backups
      bucket: ""  # Set via: --set database.restore.s3.bucket=your-bucket
      # S3 key for PostgreSQL dump (.dump or .sql)
      # Odoo.sh exports as SQL dump
      databaseKey: "restore/dump.sql"
      # S3 key for filestore - can be:
      #   - Directory path: "restore/filestore" (uses aws s3 sync)
      #   - Tarball: "restore/filestore.tar.gz" (downloads and extracts)
      filestoreKey: "restore/filestore"
      # Secret with ACCESS_KEY_ID and SECRET_ACCESS_KEY (reuse backup secret)
      secretName: "backup-s3-creds"

# =============================================================================
# Add-ons
# =============================================================================
addons:
  # Valkey (Redis-compatible) for caching (OPTIONAL)
  # With session_db module, sessions are stored in PostgreSQL - no Redis needed!
  # Enable Valkey only if you need Redis caching for performance optimization
  valkey:
    enabled: false
    storage: "5Gi"
    resources:
      requests:
        cpu: "200m"
        memory: "512Mi"
      limits:
        cpu: "1"
        memory: "2Gi"
  
  # Metabase BI for reporting and dashboards
  bi:
    enabled: true
    tool: "metabase"
    storage: "10Gi"
    # Storage class name - for EBS volumes (RWO): "ebs-sc"
    storageClassName: "ebs-sc"
    resources:
      requests:
        cpu: "1"
        memory: "2Gi"
      limits:
        cpu: "4"
        memory: "8Gi"

# =============================================================================
# Networking - AWS ALB Ingress
# =============================================================================
networking:
  ingress:
    enabled: true
    # AWS Load Balancer Controller ingress class
    className: "alb"

    # ACM Certificate ARN - easy to set via ArgoCD/--set
    # This gets injected into the ALB annotations automatically
    certificateArn: ""  # e.g., arn:aws:acm:us-east-1:123456789:certificate/xxxxx

    # ALB group name - ingresses with same group share one ALB
    groupName: "odoo-cluster"
    
    # Global ALB annotations (pre-configured for AWS)
    # These apply to both Odoo and Metabase ingresses
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/healthcheck-path: /web/health
      alb.ingress.kubernetes.io/healthcheck-interval-seconds: "30"
      alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
      alb.ingress.kubernetes.io/healthy-threshold-count: "2"
      alb.ingress.kubernetes.io/unhealthy-threshold-count: "3"
      alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=300
    
    # TLS - handled by ACM via annotations
    tls:
      enabled: true
      # No secretName needed - ALB terminates TLS with ACM cert
      secretName: ""
    
    # Odoo ingress
    odoo:
      enabled: true
      # SET THIS: Your Odoo hostname
      host: ""  # e.g., odoo.example.com
      # Additional hostnames that route to the same Odoo backend
      # Useful for CNAME aliases like www.example.com -> odoo.example.com
      additionalHosts: []
      # Example:
      # additionalHosts:
      #   - www.avware.io
      #   - app.avware.io
      path: /
      pathType: Prefix
      annotations: {}
    
    # Metabase ingress
    bi:
      enabled: true
      # SET THIS: Your Metabase hostname
      host: ""  # e.g., bi.example.com
      path: /
      pathType: Prefix
      annotations:
        # Metabase has different health check path
        alb.ingress.kubernetes.io/healthcheck-path: /api/health
  
  # Tailscale disabled for AWS deployment
  tailscale:
    authSecretName: "tailscale-auth"
    odoo:
      enabled: false
    bi:
      enabled: false

# =============================================================================
# Secrets
# =============================================================================
secrets:
  tailscale:
    create: false
  backup:
    # Set to true and provide credentials, or create secret manually
    create: false
    accessKeyId: ""
    secretAccessKey: ""
  deployKeys: []
