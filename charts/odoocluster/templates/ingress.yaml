{{- if .Values.networking.ingress.enabled }}
{{- $clusterName := include "odoocluster.name" . -}}
{{- $namespace := .Release.Namespace -}}

{{/* Odoo Ingress */}}
{{- if .Values.networking.ingress.odoo.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $clusterName }}-odoo
  namespace: {{ $namespace }}
  labels:
    {{- include "odoocluster.labels" . | nindent 4 }}
    odoo.simstech.cloud/component: odoo
  annotations:
    {{- $globalAnnotations := .Values.networking.ingress.annotations | default dict }}
    {{- $componentAnnotations := .Values.networking.ingress.odoo.annotations | default dict }}
    {{- $allAnnotations := merge $componentAnnotations $globalAnnotations }}
    {{- range $key, $value := $allAnnotations }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
    {{- if .Values.networking.ingress.certificateArn }}
    alb.ingress.kubernetes.io/certificate-arn: {{ .Values.networking.ingress.certificateArn | quote }}
    {{- end }}
    {{- if .Values.networking.ingress.groupName }}
    alb.ingress.kubernetes.io/group.name: {{ .Values.networking.ingress.groupName | quote }}
    {{- end }}
spec:
  {{- if .Values.networking.ingress.className }}
  ingressClassName: {{ .Values.networking.ingress.className | quote }}
  {{- end }}
  {{- if and .Values.networking.ingress.tls.enabled .Values.networking.ingress.odoo.host }}
  tls:
    - hosts:
        - {{ .Values.networking.ingress.odoo.host | quote }}
      {{- if .Values.networking.ingress.tls.secretName }}
      secretName: {{ .Values.networking.ingress.tls.secretName | quote }}
      {{- end }}
  {{- end }}
  rules:
    - host: {{ required "networking.ingress.odoo.host is required when ingress is enabled" .Values.networking.ingress.odoo.host | quote }}
      http:
        paths:
          - path: {{ .Values.networking.ingress.odoo.path | default "/" }}
            pathType: {{ .Values.networking.ingress.odoo.pathType | default "Prefix" }}
            backend:
              service:
                name: {{ $clusterName }}-odoo
                port:
                  number: 8069
{{- end }}

{{/* Metabase/BI Ingress */}}
{{- if and .Values.networking.ingress.bi.enabled .Values.addons.bi.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $clusterName }}-bi
  namespace: {{ $namespace }}
  labels:
    {{- include "odoocluster.labels" . | nindent 4 }}
    odoo.simstech.cloud/component: metabase
  annotations:
    {{- $globalAnnotations := .Values.networking.ingress.annotations | default dict }}
    {{- $componentAnnotations := .Values.networking.ingress.bi.annotations | default dict }}
    {{- $allAnnotations := merge $componentAnnotations $globalAnnotations }}
    {{- range $key, $value := $allAnnotations }}
    {{- if ne $key "alb.ingress.kubernetes.io/healthcheck-path" }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
    {{- end }}
    {{- if .Values.networking.ingress.certificateArn }}
    alb.ingress.kubernetes.io/certificate-arn: {{ .Values.networking.ingress.certificateArn | quote }}
    {{- end }}
    {{- if .Values.networking.ingress.groupName }}
    alb.ingress.kubernetes.io/group.name: {{ .Values.networking.ingress.groupName | quote }}
    {{- end }}
    alb.ingress.kubernetes.io/healthcheck-path: "/api/health"
spec:
  {{- if .Values.networking.ingress.className }}
  ingressClassName: {{ .Values.networking.ingress.className | quote }}
  {{- end }}
  {{- if and .Values.networking.ingress.tls.enabled .Values.networking.ingress.bi.host }}
  tls:
    - hosts:
        - {{ .Values.networking.ingress.bi.host | quote }}
      {{- if .Values.networking.ingress.tls.secretName }}
      secretName: {{ .Values.networking.ingress.tls.secretName | quote }}
      {{- end }}
  {{- end }}
  rules:
    - host: {{ required "networking.ingress.bi.host is required when bi ingress is enabled" .Values.networking.ingress.bi.host | quote }}
      http:
        paths:
          - path: {{ .Values.networking.ingress.bi.path | default "/" }}
            pathType: {{ .Values.networking.ingress.bi.pathType | default "Prefix" }}
            backend:
              service:
                name: {{ $clusterName }}-metabase
                port:
                  number: 3000
{{- end }}

{{- end }}
