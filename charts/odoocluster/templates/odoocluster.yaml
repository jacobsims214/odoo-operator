apiVersion: odoo.simstech.cloud/v1alpha1
kind: OdooCluster
metadata:
  name: {{ include "odoocluster.name" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "odoocluster.labels" . | nindent 4 }}
spec:
  odoo:
    version: {{ .Values.odoo.version | quote }}
    {{- if .Values.odoo.image }}
    image: {{ .Values.odoo.image | quote }}
    {{- end }}
    replicas: {{ .Values.odoo.replicas }}
    storage: {{ .Values.odoo.storage | quote }}
    {{- if .Values.odoo.storageClassName }}
    storageClassName: {{ .Values.odoo.storageClassName | quote }}
    {{- end }}
    {{- if .Values.odoo.resources }}
    resources:
      {{- if .Values.odoo.resources.requests }}
      requests:
        {{- if .Values.odoo.resources.requests.cpu }}
        cpu: {{ .Values.odoo.resources.requests.cpu | quote }}
        {{- end }}
        {{- if .Values.odoo.resources.requests.memory }}
        memory: {{ .Values.odoo.resources.requests.memory | quote }}
        {{- end }}
      {{- end }}
      {{- if .Values.odoo.resources.limits }}
      limits:
        {{- if .Values.odoo.resources.limits.cpu }}
        cpu: {{ .Values.odoo.resources.limits.cpu | quote }}
        {{- end }}
        {{- if .Values.odoo.resources.limits.memory }}
        memory: {{ .Values.odoo.resources.limits.memory | quote }}
        {{- end }}
      {{- end }}
    {{- end }}
    {{- if .Values.odoo.addons }}
    addons:
      {{- toYaml .Values.odoo.addons | nindent 6 }}
    {{- end }}
  
  database:
    storage: {{ .Values.database.storage | quote }}
    {{- if .Values.database.storageClassName }}
    storageClassName: {{ .Values.database.storageClassName | quote }}
    {{- end }}
    instances: {{ .Values.database.instances }}
    {{- if .Values.database.resources }}
    resources:
      {{- if .Values.database.resources.requests }}
      requests:
        {{- if .Values.database.resources.requests.cpu }}
        cpu: {{ .Values.database.resources.requests.cpu | quote }}
        {{- end }}
        {{- if .Values.database.resources.requests.memory }}
        memory: {{ .Values.database.resources.requests.memory | quote }}
        {{- end }}
      {{- end }}
      {{- if .Values.database.resources.limits }}
      limits:
        {{- if .Values.database.resources.limits.cpu }}
        cpu: {{ .Values.database.resources.limits.cpu | quote }}
        {{- end }}
        {{- if .Values.database.resources.limits.memory }}
        memory: {{ .Values.database.resources.limits.memory | quote }}
        {{- end }}
      {{- end }}
    {{- end }}
    {{- if .Values.database.backup.enabled }}
    backup:
      enabled: true
      schedule: {{ .Values.database.backup.schedule | quote }}
      retentionPolicy: {{ .Values.database.backup.retentionPolicy | quote }}
      s3:
        endpoint: {{ .Values.database.backup.s3.endpoint | quote }}
        bucket: {{ .Values.database.backup.s3.bucket | quote }}
        secretName: {{ .Values.database.backup.s3.secretName | quote }}
    {{- end }}
    {{- if .Values.database.restore.enabled }}
    restore:
      enabled: true
      s3:
        endpoint: {{ .Values.database.restore.s3.endpoint | quote }}
        bucket: {{ .Values.database.restore.s3.bucket | quote }}
        databaseKey: {{ .Values.database.restore.s3.databaseKey | quote }}
        {{- if .Values.database.restore.s3.filestoreKey }}
        filestoreKey: {{ .Values.database.restore.s3.filestoreKey | quote }}
        {{- end }}
        secretName: {{ .Values.database.restore.s3.secretName | quote }}
    {{- end }}
  
  {{- if or .Values.addons.valkey.enabled .Values.addons.bi.enabled }}
  addons:
    {{- if .Values.addons.valkey.enabled }}
    valkey:
      enabled: true
      storage: {{ .Values.addons.valkey.storage | quote }}
      {{- if .Values.addons.valkey.resources }}
      resources:
        {{- if .Values.addons.valkey.resources.requests }}
        requests:
          {{- if .Values.addons.valkey.resources.requests.cpu }}
          cpu: {{ .Values.addons.valkey.resources.requests.cpu | quote }}
          {{- end }}
          {{- if .Values.addons.valkey.resources.requests.memory }}
          memory: {{ .Values.addons.valkey.resources.requests.memory | quote }}
          {{- end }}
        {{- end }}
        {{- if .Values.addons.valkey.resources.limits }}
        limits:
          {{- if .Values.addons.valkey.resources.limits.cpu }}
          cpu: {{ .Values.addons.valkey.resources.limits.cpu | quote }}
          {{- end }}
          {{- if .Values.addons.valkey.resources.limits.memory }}
          memory: {{ .Values.addons.valkey.resources.limits.memory | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
    {{- if .Values.addons.bi.enabled }}
    bi:
      enabled: true
      tool: {{ .Values.addons.bi.tool | quote }}
      storage: {{ .Values.addons.bi.storage | quote }}
      {{- if .Values.addons.bi.storageClassName }}
      storageClassName: {{ .Values.addons.bi.storageClassName | quote }}
      {{- end }}
      {{- if .Values.addons.bi.resources }}
      resources:
        {{- if .Values.addons.bi.resources.requests }}
        requests:
          {{- if .Values.addons.bi.resources.requests.cpu }}
          cpu: {{ .Values.addons.bi.resources.requests.cpu | quote }}
          {{- end }}
          {{- if .Values.addons.bi.resources.requests.memory }}
          memory: {{ .Values.addons.bi.resources.requests.memory | quote }}
          {{- end }}
        {{- end }}
        {{- if .Values.addons.bi.resources.limits }}
        limits:
          {{- if .Values.addons.bi.resources.limits.cpu }}
          cpu: {{ .Values.addons.bi.resources.limits.cpu | quote }}
          {{- end }}
          {{- if .Values.addons.bi.resources.limits.memory }}
          memory: {{ .Values.addons.bi.resources.limits.memory | quote }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
  
  {{- if or .Values.networking.tailscale.odoo.enabled .Values.networking.tailscale.bi.enabled }}
  networking:
    tailscale:
      authSecretName: {{ .Values.networking.tailscale.authSecretName | quote }}
      {{- if .Values.networking.tailscale.odoo.enabled }}
      odoo:
        enabled: true
        hostname: {{ include "odoocluster.odooHostname" . | quote }}
        funnel: {{ .Values.networking.tailscale.odoo.funnel }}
        tags: {{ .Values.networking.tailscale.odoo.tags | quote }}
      {{- end }}
      {{- if .Values.networking.tailscale.bi.enabled }}
      bi:
        enabled: true
        hostname: {{ include "odoocluster.biHostname" . | quote }}
        funnel: {{ .Values.networking.tailscale.bi.funnel }}
        tags: {{ .Values.networking.tailscale.bi.tags | quote }}
      {{- end }}
  {{- end }}

